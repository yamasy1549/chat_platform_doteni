{% extends "layout_simple.html" %}

{% block body %}
  <div class="flex">
    <div class="scenario_area">
      <h3>シナリオ</h3>
      {% for scenario in scenarios %}
        <pre>{{ scenario.text }}</pre>
      {% endfor %}
    </div>

    <div class="message_area">
      <h3>メッセージ</h3>
      <ol id="messageList">
        {% for message in room.messages %}
          <li>
            <div class="message">
              {{ message.user.name }}: {{ message.text }}
            </div>
          </li>
        {% endfor %}
      </ol>

      <div class="form_horizontal">
        <input type="submit" value="対話開始" onclick="startMessage()" class="button danger">
        <input type="submit" value="対話終了" onclick="endMessage()" class="button danger">
        <small>定員 <span id="userList">0</span>/{{ room.scenarios|length }}人</small>
      </div>

      <form action="" method="" id="form">
        <div class="form_horizontal">
          <textarea type="text" id="text" name="text" /></textarea>
        </div>

        <div class="form_horizontal">
          <input type="submit" value="送信" class="button">
        </div>
      </form>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js" integrity="sha512-q/dWJ3kcmjBLU4Qc47E4A9kTB4m3wuTY7vkFJDTZKjTs8jhyGQnaUrxa0Ytd0ssMZhbNua9hE+E7Qv1j+DyZwA==" crossorigin="anonymous"></script>
  <script type="text/javascript" charset="utf-8">
    const hash_id = location.pathname.split("/").pop();

    const form = document.getElementById("form");
    const textarea = document.getElementById("text");
    const messageList = document.getElementById("messageList");
    const userList = document.getElementById("userList");

    const socket = io();

    socket.on("connect", function() {
      socket.emit("join", {
        hash_id: hash_id,
      });

      socket.on("room_message", function(payload) {
        const li = document.createElement("li");
        const div = document.createElement("div");
        const content = document.createTextNode(`${payload.name}: ${payload.text}`);

        div.classList.add("message");
        div.appendChild(content);
        li.appendChild(div);
        messageList.appendChild(li);
      });

      socket.on("room_user", function(payload) {
        userList.innerText = payload.users.length;
      });
    });

    form.addEventListener("submit", function(event) {
      event.preventDefault();
      socket.emit("create_message", {
        hash_id: hash_id,
        text: textarea.value,
      });
      textarea.value = "";
    });

    function startMessage() {
      if(confirm("対話を開始しますか？")) {
        socket.emit("meta_start_message");
      }
    }

    function endMessage() {
      if(confirm("対話を終了しますか？")) {
        socket.emit("meta_end_message");
      }
    }
  </script>
{% endblock %}
